<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camera â€¢ License Scan (On-device)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
    }
    .cam-wrap {
      margin-top: 16px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .preview {
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 16/10;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .snap {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .snap button {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-capture { background: #2563eb; }
    .btn-scan { background: #22c55e; }
    .btn-stop { background: #ef4444; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    canvas {
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }
    img.license-preview {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .hide {
      display: none !important;
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar">
  <h2 class="logo">ðŸš¦ Smart Traffic</h2>
  <ul>
    <li><a href="{{ url_for('index') }}">ðŸ“Š Dashboard</a></li>
    <li><a href="{{ url_for('manual') }}">ðŸ“· Camera Control</a></li>
    <li><a href="{{ url_for('auto') }}">âš™ Auto Mode</a></li>
    <li><a href="{{ url_for('emergency') }}">ðŸš¨ Emergency</a></li>
    <li class="active"><a href="{{ url_for('manual') }}">ðŸ“· Camera</a></li>
    <li><a href="{{ url_for('settings') }}">âš¡ Settings</a></li>
  </ul>
</nav>

<!-- Main -->
<div class="main">
  <header class="header">
    <h1>Camera â€” License Scan</h1>
    <div class="header-right">
      <span class="pill">On-device OCR</span>
      <span style="margin-left:12px;color:#6b7280;font-size:.9rem">User: {{ username }}</span>
    </div>
  </header>

  <div class="cam-wrap">

    <!-- Left: Camera Section -->
    <div class="card" style="flex:1; min-width:320px;">
      <h2>Live Feed</h2>
      <div class="preview">
        <video id="video" autoplay playsinline></video>
      </div>
      <div class="snap">
        <button class="btn-capture" id="btnStart">Start Camera</button>
        <button class="btn-stop" id="btnStop" disabled>Stop</button>
        <button class="btn-scan" id="btnSnap" disabled>Capture & Scan</button>
        <span class="muted">Tip: License ko frame me seedha rakho.</span>
      </div>
      <canvas id="canvas" class="hide"></canvas>
    </div>

    <!-- Right: License Section -->
    <div class="card" style="flex:1; min-width:320px;">
      <h2>Generated License</h2>
      <img id="licenseImg" class="license-preview hide" alt="Generated License">
    </div>

  </div>
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnSnap  = document.getElementById('btnSnap');
  const licenseImg = document.getElementById('licenseImg');
  let stream;

  btnStart.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnSnap.disabled = false;
    } catch (e) {
      alert('Camera access blocked. Please allow permission.');
    }
  };

  btnStop.onclick = () => {
    stream?.getTracks().forEach(t => t.stop());
    video.srcObject = null;
    btnStart.disabled = false;
    btnStop.disabled = true;
    btnSnap.disabled = true;
  };

  async function runOCR(image) {
    const { data } = await Tesseract.recognize(image, 'eng');
    return { text: data.text, conf: Math.round(data.confidence) };
  }

  async function uploadCapturedImage(canvas) {
    const dataURL = canvas.toDataURL('image/png');
    try {
      const res = await fetch('/save_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL })
      });
      const j = await res.json();
      if (j.status === 'ok') {
        const licenseUrl = `/captured_images/${j.license_filename}`;
        licenseImg.src = licenseUrl + '?t=' + Date.now();
        licenseImg.classList.remove('hide');
        return j;
      } else {
        alert("Server error: " + (j.message || 'unknown'));
        return j;
      }
    } catch (err) {
      console.error('Error saving image', err);
      alert('Server error while saving image.');
      return { status: 'error' };
    }
  }

  btnSnap.onclick = async () => {
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) { alert('Camera not ready'); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    btnSnap.disabled = true;
    btnSnap.textContent = 'Processing...';

    try {
      await runOCR(canvas);
      const result = await uploadCapturedImage(canvas);
      if (result.status === 'ok') {
        if (result.face_found) {
          alert('Face detected â€” mock license created.');
        } else {
          alert('No clear face detected â€” mock license created using full image.');
        }
      }
    } catch (e) {
      console.error(e);
      alert('Processing failed. Try again with better lighting/focus.');
    } finally {
      btnSnap.disabled = false;
      btnSnap.textContent = 'Capture & Scan';
    }
  };
</script>
</body>
</html>
