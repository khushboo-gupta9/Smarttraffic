<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Smart Traffic Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .settings-container {
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 20px auto;
    }
    .setting-section { margin-bottom: 20px; }
    .setting-section h3 { margin-bottom: 10px; }
    input, select { width: 80px; padding: 5px; margin-bottom: 10px; }
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #1e3a8a;
      color: #fff;
    }
  </style>
</head>
<body>

<!-- Sidebar/Navbar -->
<nav class="sidebar">
  <h2 class="logo">🚦 Smart Traffic</h2>
  <ul>
    <li><a href="{{ url_for('index') }}">📊 Dashboard</a></li>
    <li><a href="{{ url_for('manual') }}">📷 Camera Control</a></li>
    <li><a href="{{ url_for('auto') }}">⚙ Auto Mode</a></li>
    <li><a href="{{ url_for('emergency') }}">🚨 Emergency</a></li>
    <li class="active"><a href="{{ url_for('settings') }}">⚡ Settings</a></li>
  </ul>
</nav>

<!-- Main Content -->
<div class="main">
  <header class="header">
    <h1>Settings</h1>
    <p class="muted">Configure signal timings, mode & sensors.</p>
  </header>

  <div class="settings-container">
    <h2>⚙ Traffic System Settings</h2>

    <div class="setting-section">
      <h3>⏱ Signal Timings</h3>
      <label>Green Duration (sec):</label>
      <input type="number" id="green-time"><br>
      <label>Yellow Duration (sec):</label>
      <input type="number" id="yellow-time"><br>
      <label>Red Duration (sec):</label>
      <input type="number" id="red-time">
    </div>

    <div class="setting-section">
      <h3>🚦 Default Mode</h3>
      <select id="default-mode">
        <option value="auto">Auto</option>
        <option value="manual">Manual</option>
        <option value="emergency">Emergency</option>
      </select>
    </div>

    <div class="setting-section">
      <h3>🔧 Sensors</h3>
      <label><input type="checkbox" id="density-sensor"> Enable Density Sensor</label><br>
      <label><input type="checkbox" id="siren-sensor"> Enable Siren Detection</label>
    </div>

    <button onclick="saveSettings()">💾 Save & Apply</button>
  </div>
</div>

<script>
  // Load previous settings
  function loadSettings() {
    const saved = JSON.parse(localStorage.getItem("trafficSettings"));
    if (saved) {
      document.getElementById("green-time").value = saved.green;
      document.getElementById("yellow-time").value = saved.yellow;
      document.getElementById("red-time").value = saved.red;
      document.getElementById("default-mode").value = saved.mode;
      document.getElementById("density-sensor").checked = saved.density;
      document.getElementById("siren-sensor").checked = saved.siren;
    } else {
      // default values
      document.getElementById("green-time").value = 15;
      document.getElementById("yellow-time").value = 5;
      document.getElementById("red-time").value = 20;
      document.getElementById("default-mode").value = "auto";
      document.getElementById("density-sensor").checked = true;
      document.getElementById("siren-sensor").checked = true;
    }
  }

  loadSettings();

  function saveSettings() {
    const settings = {
      green: parseInt(document.getElementById("green-time").value),
      yellow: parseInt(document.getElementById("yellow-time").value),
      red: parseInt(document.getElementById("red-time").value),
      mode: document.getElementById("default-mode").value,
      density: document.getElementById("density-sensor").checked,
      siren: document.getElementById("siren-sensor").checked
    };

    // Save in localStorage
    localStorage.setItem("trafficSettings", JSON.stringify(settings));

    // Dispatch custom event so other tabs can react
    window.dispatchEvent(new Event('storage')); 

    // Optionally send to server (Flask)
    fetch("/update_timing", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(settings)
    })
    .then(res => res.json())
    .then(data => alert("✅ Settings saved! Dashboard updated."))
    .catch(err => {
      console.error(err);
      alert("❌ Failed to save on server.");
    });
  }
</script>

</body>
</html>
