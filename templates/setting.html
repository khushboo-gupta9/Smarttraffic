<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Smart Traffic Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .settings-container {
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 20px auto;
    }
    .setting-section { margin-bottom: 20px; }
    .setting-section h3 { margin-bottom: 10px; }
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #1e3a8a;
      color: #fff;
    }
  </style>
</head>
<body>

<!-- Sidebar/Navbar -->
<nav class="sidebar">
  <h2 class="logo">üö¶ Smart Traffic</h2>
  <ul>
    <li><a href="{{ url_for('index') }}">üìä Dashboard</a></li>
    <li><a href="{{ url_for('manual') }}">üì∑ Camera Control</a></li>
    <li><a href="{{ url_for('auto') }}">‚öô Auto Mode</a></li>
    <li><a href="{{ url_for('emergency') }}">üö® Emergency</a></li>
    <li><a href="{{ url_for('manual') }}">üì∑ Camera</a></li>
    <li class="active"><a href="{{ url_for('settings') }}">‚ö° Settings</a></li>
  </ul>
</nav>

<!-- Main Content -->
<div class="main">
  <header class="header">
    <h1>Settings</h1>
    <p class="muted">Configure signal timings, mode & sensors.</p>
  </header>

  <div class="settings-container">
    <h2>‚öô Traffic System Settings</h2>

    <div class="setting-section">
      <h3>‚è± Signal Timings</h3>
      <label>Green Duration (sec):</label>
      <input type="number" id="green-time" value="30"><br>
      <label>Yellow Duration (sec):</label>
      <input type="number" id="yellow-time" value="5"><br>
      <label>Red Duration (sec):</label>
      <input type="number" id="red-time" value="25">
    </div>

    <div class="setting-section">
      <h3>üö¶ Default Mode</h3>
      <select id="default-mode">
        <option value="auto">Auto</option>
        <option value="manual">Manual</option>
        <option value="emergency">Emergency</option>
      </select>
    </div>

    <div class="setting-section">
      <h3>üîß Sensors</h3>
      <label><input type="checkbox" id="density-sensor" checked> Enable Density Sensor</label><br>
      <label><input type="checkbox" id="siren-sensor" checked> Enable Siren Detection</label>
    </div>

    <button onclick="saveSettings()">üíæ Save & Apply</button>
  </div>
</div>

<script>
  async function saveSettings() {
    const settings = {
      green: parseInt(document.getElementById("green-time").value),
      yellow: parseInt(document.getElementById("yellow-time").value),
      red: parseInt(document.getElementById("red-time").value),
      mode: document.getElementById("default-mode").value,
      density: document.getElementById("density-sensor").checked,
      siren: document.getElementById("siren-sensor").checked
    };

    try {
      const res = await fetch("/save_settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings)
      });
      const data = await res.json();
      if (data.status === "ok") {
        // Save locally (optional)
        localStorage.setItem("trafficSettings", JSON.stringify(settings));
        alert("‚úÖ Settings applied successfully!");

        // Notify other tabs/pages (if dashboard open) via storage event
        window.dispatchEvent(new Event('settingsUpdated'));
      } else {
        alert("‚ùå Failed to save settings: " + (data.message || "server error"));
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Failed to apply settings. Check server logs.");
    }
  }

  // Populate current settings on page load
  (async function loadCurrentSettings(){
    try {
      const res = await fetch("/get_settings");
      const s = await res.json();
      if (s) {
        document.getElementById("green-time").value = s.green || 30;
        document.getElementById("yellow-time").value = s.yellow || 3;
        document.getElementById("red-time").value = s.red || 18;
        document.getElementById("default-mode").value = s.mode || 'auto';
        document.getElementById("density-sensor").checked = !!s.density_sensor;
        document.getElementById("siren-sensor").checked = !!s.siren_sensor;
      }
    } catch(e){
      console.warn("Could not load server settings:", e);
    }
  })();
</script>

</body>
</html>
